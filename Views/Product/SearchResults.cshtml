@using CuaHangQuanAo.Entities
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model IEnumerable<Item>

@functions {
    // Helper to get the first variant image or fallback
    string GetProductImage(Item item)
    {
        var firstVariantImage = item.ProductVariants?.FirstOrDefault(v => !string.IsNullOrEmpty(v.Image))?.Image;
        if (!string.IsNullOrEmpty(firstVariantImage))
        {
            // Nếu là URL tuyệt đối thì trả về luôn, ngược lại build đường dẫn đúng thư mục
            return firstVariantImage.StartsWith("http", StringComparison.OrdinalIgnoreCase)
                ? firstVariantImage
                : Url.Content($"~/Images/products/{firstVariantImage}");
        }
        // Fallback chắc chắn tồn tại trong repo
        return Url.Content("~/Images/demo/demo.webp");
    }
}

<style>
    .ajax-products {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
    }

    .ajax-card {
        background: #fff;
        border-radius: 8px;
        padding: 8px;
        text-align: center;
        box-shadow: 0 2px 6px rgba(0,0,0,.05);
        transition: .2s;
    }

        .ajax-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }

    .ajax-img {
        width: 100%;
        height: 110px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 6px;
    }

    .ajax-title {
        font-size: .85rem;
        font-weight: 600;
        color: #222;
        margin-bottom: 3px;
        line-height: 1.2;
    }

    .ajax-price {
        font-size: .8rem;
        color: #e67e22;
        font-weight: 700;
    }

</style>

@if (!Model.Any())
{
    <div class="text-center text-muted py-4">Không có sản phẩm phù hợp.</div>
}
else
{
    <div class="ajax-products">
        @foreach (var p in Model)
        {
            var img = GetProductImage(p);
            <div class="ajax-card">
                <a asp-controller="Product" asp-action="Detail" asp-route-id="@p.ItemsId">
                    <img class="ajax-img" src="@img" onerror="this.onerror=null;this.src='@Url.Content("~/Images/demo/demo.webp")'" alt="@p.ItemsName" />
                </a>
                <div class="ajax-title">
                    <a class="text-decoration-none text-dark"
                       asp-controller="Product" asp-action="Detail" asp-route-id="@p.ItemsId">
                        @p.ItemsName
                    </a>
                </div>
                <div class="ajax-price">@string.Format("{0:N0} đ", p.SellPrice)</div>
            </div>
        }
    </div>
}