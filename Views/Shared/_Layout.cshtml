<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CuaHangQuanAo</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/CuaHangQuanAo.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    @RenderSection("Meta", required: false)

</head>
<body>
    <header>
        <!-- Modern navbar with better aesthetics -->
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background: linear-gradient(135deg, #0a2463 0%, #3e92cc 100%);">
            <div class="container">
                <!-- Enhanced Brand with animation -->
                <a class="navbar-brand d-flex align-items-center" asp-controller="Home" asp-action="Index">
                    <img class="logo me-2" src="~/Images/demo/logo.svg" onerror="this.style.display='none';" alt="logo"
                         style="width: 42px; height: auto; transition: all 0.3s ease-in-out;">
                    <span class="fw-bold fs-4" style="letter-spacing: 0.8px; background: linear-gradient(to right, #fff, #e6e6e6);
                       -webkit-background-clip: text; background-clip: text; color: transparent;">CuaHangQuanAo</span>
                </a>

                <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Enhanced Search Box -->
                    <div class="mx-auto my-3 my-lg-0" style="max-width: 50%;">
                        <div class="position-relative">
                            <div class="input-group">
                                <input id="homeSearch" type="search" class="form-control form-control-lg border-0 shadow-none"
                                       placeholder="Tìm sản phẩm bạn muốn... (gõ để tìm nhanh)"
                                       style="border-radius: 25px 0 0 25px; background-color: rgba(255,255,255,0.15); color: #fff;">
                                <button class="btn btn-light px-3" type="button" style="border-radius: 0 25px 25px 0; background: rgba(255,255,255,0.25); border: none;">
                                    <i class="bi bi-search text-white"></i>
                                </button>
                            </div>
                            <!-- Dropdown suggestion box -->
                            <div id="suggestBox" class="list-group position-absolute w-100 shadow-sm rounded-3 mt-1"
                                 style="z-index:1000; display:none; max-height:360px; overflow:auto;"></div>
                        </div>
                        <div id="ajaxResults" class="mt-2"></div>
                    </div>

                    <!-- Enhanced Nav items with hover effects -->
                    <ul class="navbar-nav ms-auto align-items-lg-center">
                        <!-- Categories with subtle hover animations -->
                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="aoDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-tshirt me-1"></i> Áo
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2 animate__animated animate__fadeIn"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="aoDropdown">
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="7">Áo thun</a></li>
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="5">Áo sơ mi</a></li>
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="4">Áo polo</a></li>
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-q="áo khoác">Áo khoác</a></li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="quanDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-handbag me-1"></i> Quần
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="quanDropdown">
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-q="jeans">Quần jeans</a></li>
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-q="short">Quần short</a></li>
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="3">Quần tây</a></li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="phuKienDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-gem me-1"></i> Phụ kiện
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="phuKienDropdown">
                                <li>
                                    <a class="dropdown-item py-2" asp-controller="Product" asp-action="PhuKien" asp-route-CategoryId="8">
                                        <i class="bi bi-shoe-1 me-2"></i> Giày
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item py-2" asp-controller="Product" asp-action="PhuKien" asp-route-CategoryId="9">
                                        <i class="bi bi-award me-2"></i> Thắt lưng
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider opacity-25" /></li>
                                <li>
                                    <a class="dropdown-item py-2" asp-controller="Product" asp-action="PhuKien">
                                        <i class="bi bi-grid me-2"></i> Tất cả phụ kiện
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="suitDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-suit-heart me-1"></i> Suit
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="suitDropdown">
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="2">Suit luxury</a></li>
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="1">BST Vest</a></li>
                            </ul>
                        </li>

                        <!-- Enhanced Auth buttons -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            <li class="nav-item mx-1">
                                <a class="nav-link text-white position-relative" asp-controller="Cart" asp-action="Index">
                                    <i class="bi bi-cart-fill fs-5"></i>
                                    <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                                          style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000;">
                                        0
                                        <span class="visually-hidden">items in cart</span>
                                    </span>
                                </a>
                            </li>
                            <li class="nav-item dropdown mx-1">
                                <a class="nav-link dropdown-toggle text-white" href="#" id="userDropdown"
                                   role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-person-circle fs-5 me-1"></i>
                                    <span class="d-none d-lg-inline" style="font-weight: 500;">@User.Identity.Name</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 mt-2"
                                    style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                    aria-labelledby="userDropdown">
                                    <li>
                                        <a class="dropdown-item py-2" asp-controller="Profile" asp-action="Index">
                                            <i class="bi bi-person-badge me-2 text-primary"></i> Thông tin cá nhân
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item py-2" asp-controller="Profile" asp-action="Orders">
                                            <i class="bi bi-receipt me-2 text-success"></i> Đơn hàng của tôi
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider opacity-25" /></li>
                                    <li>
                                        <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="dropdown-item py-2 text-danger">
                                                <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item ms-lg-2">
                                <a asp-controller="Account" asp-action="Register"
                                   class="btn btn-sm btn-outline-light rounded-pill px-3 me-2 fw-medium"
                                   style="border-width: 2px; transition: all 0.3s ease;">
                                    <i class="bi bi-person-plus-fill me-1"></i> Signup
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path"
                                   class="btn btn-sm rounded-pill px-3 fw-medium"
                                   style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; box-shadow: 0 4px 10px rgba(255, 165, 0, 0.3); transition: all 0.3s ease;
                                   position: relative;">
                                    <i class="bi bi-box-arrow-in-right me-1"></i> Login
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                                          style="background: radial-gradient(circle at top right, #FFD700, #FFA500); color: #000;
                                           transform: translate(50%, -50%); font-size: 80%; padding: 0.2em 0.5em;">NEW</span>
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Add this to the head section of the document -->
    <style>
        /* Hover effect for nav items */
        .navbar-nav .nav-link:hover .position-absolute {
            width: 80%;
        }

        /* Subtle hover animation for dropdown items */
        .dropdown-item {
            transition: all 0.2s ease;
            position: relative;
        }

            .dropdown-item:hover {
                background-color: rgba(0, 123, 255, 0.08);
                transform: translateX(5px);
            }

        /* Enhanced search input placeholder */
        #homeSearch::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Smooth transition for buttons */
        .btn {
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        /* Logo hover animation */
        .navbar-brand:hover img {
            transform: scale(1.1) rotate(5deg);
        }

        /* Enhanced navbar shadow */
        .navbar {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* Chat widget styles */
        .chat-widget-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 9998;
            transition: all 0.3s ease;
            border: none;
        }

            .chat-widget-button:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
            }

            .chat-widget-button svg {
                width: 28px;
                height: 28px;
                fill: white;
            }

        .chat-widget-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        /* Cửa sổ chat */
        .chat-widget-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @@keyframes slideUp {
            from

        {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-widget-window.active {
            display: flex;
        }

        /* Header chat */
        .chat-widget-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-widget-header-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-widget-header-info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

            .chat-widget-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

        /* Body chat */
        .chat-widget-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-message-incoming {
            display: flex;
            gap: 10px;
        }

        .chat-message-outgoing {
            display: flex;
            justify-content: flex-end;
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message-content {
            max-width: 70%;
        }

        .chat-message-user {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .chat-message-text {
            background: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }

        .chat-message-outgoing .chat-message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .chat-system-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 10px 0;
            font-style: italic;
        }

        .chat-typing-indicator {
            display: none;
            padding: 10px 0;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        /* Input area */
        .chat-widget-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

            .chat-widget-input input {
                flex: 1;
                padding: 12px 15px;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.3s;
            }

                .chat-widget-input input:focus {
                    border-color: #667eea;
                }

        .chat-widget-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

            .chat-widget-send:hover {
                transform: scale(1.1);
            }

            .chat-widget-send svg {
                width: 20px;
                height: 20px;
                fill: white;
            }

        /* Welcome screen */
        .chat-welcome {
            text-align: center;
            padding: 40px 20px;
        }

        .chat-welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .chat-welcome-icon svg {
                width: 40px;
                height: 40px;
                fill: white;
            }

        .chat-welcome h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        .chat-welcome p {
            color: #666;
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        .chat-welcome input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
            outline: none;
        }

            .chat-welcome input:focus {
                border-color: #667eea;
            }

        .chat-welcome button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

            .chat-welcome button:hover {
                transform: translateY(-2px);
            }

        /* Online users count */
        .chat-online-users {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-online-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100%

        {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        }

        /* Responsive */
        @@media (max-width: 480px) {
            .chat-widget-window

        {
            width: calc(100% - 40px);
            height: calc(100vh - 110px);
            bottom: 90px;
            right: 20px;
            left: 20px;
        }

        }

        /* Thêm vào phần styles hiện có */
    
    .chat-mode-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #4ade80;
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
        transition: all 0.3s ease;
    }
    
    .chat-mode-badge.admin-mode {
        background: #f59e0b;
        animation: modeSwitch 0.5s ease;
    }
    
    @@keyframes modeSwitch {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Hiệu ứng cho tin nhắn system đặc biệt */
    .chat-system-message.switching {
        background: linear-gradient(90deg, #667eea, #764ba2);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 500;
    }
    </style>



    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="site-footer">
        <div class="footer-main">
            <div class="footer-columns">
                <div class="footer-col">
                    <h4>CuaHangQuanAo</h4>
                    <ul>
                        <li><a href="#">Giới thiệu</a></li>
                        <li><a href="#">Tuyển dụng</a></li>
                        <li><a href="#">Liên hệ</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>CHÍNH SÁCH</h4>
                    <ul>
                        <li><a href="#">Chính sách bảo hành</a></li>
                        <li><a href="#">Chính sách giao hàng</a></li>
                        <li><a href="#">Chính sách bảo mật</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>THÔNG TIN</h4>
                    <ul>
                        <li><a href="#">Hướng dẫn mua hàng</a></li>
                        <li><a href="#">Hướng dẫn thanh toán</a></li>
                        <li><a href="#">Hướng dẫn trả góp</a></li>
                        <li><a href="#">Tra cứu địa chỉ bảo hành</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    <script>
        // Load cart count on page load
        $(document).ready(function() {
            loadCartCount();
        });
        
        function loadCartCount() {
            $.get('/Cart/GetCartCount')
                .done(function(data) {
                    if (data && data.count !== undefined) {
                        $('#cartCount').text(data.count);
                    }
                })
                .fail(function() {
                    console.log('Failed to load cart count');
                });
        }
        
        // Function to update cart count (can be called from other pages)
        function updateCartCount(newCount) {
            $('#cartCount').text(newCount);
        }
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)


    <!-- Thêm vào _Layout.cshtml hoặc Index.cshtml trước thẻ đóng </body> -->

    <style>
        /* Nút mở chat */
        .chat-widget-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 9998;
            transition: all 0.3s ease;
            border: none;
        }

            .chat-widget-button:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
            }

            .chat-widget-button svg {
                width: 28px;
                height: 28px;
                fill: white;
            }

        .chat-widget-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        /* Cửa sổ chat */
        .chat-widget-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @@keyframes slideUp {
            from

        {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-widget-window.active {
            display: flex;
        }

        /* Header chat */
        .chat-widget-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-widget-header-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-widget-header-info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

            .chat-widget-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

        /* Body chat */
        .chat-widget-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-message-incoming {
            display: flex;
            gap: 10px;
        }

        .chat-message-outgoing {
            display: flex;
            justify-content: flex-end;
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message-content {
            max-width: 70%;
        }

        .chat-message-user {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .chat-message-text {
            background: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }

        .chat-message-outgoing .chat-message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .chat-system-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 10px 0;
            font-style: italic;
        }

        .chat-typing-indicator {
            display: none;
            padding: 10px 0;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        /* Input area */
        .chat-widget-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

            .chat-widget-input input {
                flex: 1;
                padding: 12px 15px;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.3s;
            }

                .chat-widget-input input:focus {
                    border-color: #667eea;
                }

        .chat-widget-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

            .chat-widget-send:hover {
                transform: scale(1.1);
            }

            .chat-widget-send svg {
                width: 20px;
                height: 20px;
                fill: white;
            }

        /* Welcome screen */
        .chat-welcome {
            text-align: center;
            padding: 40px 20px;
        }

        .chat-welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .chat-welcome-icon svg {
                width: 40px;
                height: 40px;
                fill: white;
            }

        .chat-welcome h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        .chat-welcome p {
            color: #666;
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        .chat-welcome input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
            outline: none;
        }

            .chat-welcome input:focus {
                border-color: #667eea;
            }

        .chat-welcome button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

            .chat-welcome button:hover {
                transform: translateY(-2px);
            }

        /* Online users count */
        .chat-online-users {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-online-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100%

        {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        }

        /* Responsive */
        @@media (max-width: 480px) {
            .chat-widget-window

        {
            width: calc(100% - 40px);
            height: calc(100vh - 110px);
            bottom: 90px;
            right: 20px;
            left: 20px;
        }

        }

        /* Thêm vào phần styles hiện có */
    
    .chat-mode-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #4ade80;
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
        transition: all 0.3s ease;
    }
    
    .chat-mode-badge.admin-mode {
        background: #f59e0b;
        animation: modeSwitch 0.5s ease;
    }
    
    @@keyframes modeSwitch {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Hiệu ứng cho tin nhắn system đặc biệt */
    .chat-system-message.switching {
        background: linear-gradient(90deg, #667eea, #764ba2);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 500;
    }
    </style>

    <!-- Nút mở chat -->
    <button class="chat-widget-button" id="chatWidgetButton">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
        </svg>
        <span class="chat-widget-badge" id="chatBadge">0</span>
    </button>

    <!-- Cửa sổ chat -->
    <div class="chat-widget-window" id="chatWidget">
        <div class="chat-widget-header">
            <div class="chat-widget-header-info">
                <h3>
                    💬 Live Chat
                    <span id="chatModeBadge" class="chat-mode-badge" style="display:none;">Bot</span>
                </h3>
                <div class="chat-online-users">
                    <span class="chat-online-dot"></span>
                    <p><span id="onlineUsersCount">0</span> người online</p>
                </div>
            </div>
            <button class="chat-widget-close" id="closeChat">✕</button>
        </div>

        <!-- Welcome screen -->
        <div class="chat-welcome" id="chatWelcome">
            <div class="chat-welcome-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                </svg>
            </div>
            <h4>Chào mừng bạn!</h4>
            <p>Nhập tên của bạn để bắt đầu trò chuyện</p>
            <input type="text" id="chatUsername" placeholder="Tên của bạn..." maxlength="20">
            <button onclick="startChat()">Bắt đầu chat</button>
        </div>

        <!-- Support options - Chọn bot hoặc admin -->
        <div class="chat-support-options" id="chatSupportOptions" style="display: none;">
            <p style="margin:0 0 15px 0; font-weight:600; color:#333; text-align:center;">
                Bạn muốn chat với:
            </p>
            <button class="support-btn bot-btn" onclick="continueWithBot()">
                <span>🤖</span> <span>Chat với Bot AI</span>
            </button>
            <button class="support-btn admin-btn" onclick="requestAdminSupport()">
                <span>👨‍💼</span> <span>Nhắn với Quản trị viên</span>
            </button>
        </div>

        <!-- THÊM MỚI: Quick Questions Container -->
        <div class="quick-questions-container" id="quickQuestionsContainer">
            <div class="quick-questions-title">💡 Câu hỏi thường gặp</div>
            <div class="quick-questions-grid" id="quickQuestionsGrid">
                <!-- Các nút sẽ được thêm bằng JavaScript -->
            </div>
        </div>

        <!-- Chat body -->
        <div class="chat-widget-body" id="chatBody" style="display: none;"></div>

        <div class="chat-typing-indicator" id="typingIndicator">Ai đó đang gõ...</div>

        <!-- Input area -->
        <div class="chat-widget-input" id="chatInput" style="display: none;">
            <input type="text" id="messageInput" placeholder="Nhập tin nhắn...">
            <button class="chat-widget-send" onclick="sendChatMessage()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        let chatConnection = null;
        let currentChatUser = "";
        let chatTypingTimer;
        let unreadMessages = 0;
        let isChatOpen = false;
        let chatMode = "none";
        
        // Định nghĩa các câu hỏi nhanh với icon và câu trả lời
        const quickQuestions = [
            {
                id: 'greeting',
                icon: '👋',
                text: 'Xin chào',
                responses: [
                    "Xin chào! Tôi là Bot hỗ trợ của CuaHangQuanAo. Rất vui được phục vụ bạn!",
                    "Chào bạn! Tôi có thể giúp bạn tìm hiểu về sản phẩm, giá cả, hoặc chính sách của shop. Bạn muốn biết gì nhất?"
                ]
            },
            {
                id: 'products',
                icon: '👕',
                text: 'Sản phẩm mới',
                responses: [
                    "Hiện tại shop có rất nhiều sản phẩm hot đang sale:\n\n" +
                    "🔥 Áo thun premium - Giá từ 200.000đ\n" +
                    "🔥 Áo sơ mi công sở - Giá từ 350.000đ\n" +
                    "🔥 Quần jeans cao cấp - Giá từ 450.000đ\n" +
                    "🔥 Suit luxury - Giá từ 2.500.000đ\n\n" +
                    "Bạn quan tâm loại nào ạ?"
                ]
            },
            {
                id: 'price',
                icon: '💰',
                text: 'Bảng giá',
                responses: [
                    "Đây là bảng giá tham khảo của shop:\n\n" +
                    "📌 Áo thun: 200.000đ - 400.000đ\n" +
                    "📌 Áo sơ mi: 350.000đ - 650.000đ\n" +
                    "📌 Áo polo: 300.000đ - 500.000đ\n" +
                    "📌 Quần jeans: 450.000đ - 800.000đ\n" +
                    "📌 Quần tây: 400.000đ - 750.000đ\n" +
                    "📌 Suit: 2.500.000đ - 5.000.000đ\n\n" +
                    "Giá đã bao gồm VAT. Shop có nhiều chương trình khuyến mãi hấp dẫn!"
                ]
            },
            {
                id: 'shipping',
                icon: '🚚',
                text: 'Vận chuyển',
                responses: [
                    "Thông tin về vận chuyển:\n\n" +
                    "✅ MIỄN PHÍ SHIP cho đơn từ 500.000đ (Nội thành HN, HCM)\n" +
                    "✅ Phí ship 30.000đ cho đơn dưới 500.000đ\n" +
                    "✅ Giao hàng toàn quốc qua các đơn vị:\n" +
                    "   • Giao Hàng Nhanh (2-3 ngày)\n" +
                    "   • J&T Express (3-5 ngày)\n" +
                    "   • Viettel Post (3-7 ngày)\n\n" +
                    "📦 Đóng gói cẩn thận, kiểm tra trước khi giao!"
                ]
            },
            {
                id: 'size',
                icon: '📏',
                text: 'Hướng dẫn size',
                responses: [
                    "Hướng dẫn chọn size:\n\n" +
                    "📐 Size S: 45-55kg, cao 1m50-1m60\n" +
                    "📐 Size M: 55-65kg, cao 1m60-1m70\n" +
                    "📐 Size L: 65-75kg, cao 1m70-1m75\n" +
                    "📐 Size XL: 75-85kg, cao 1m75-1m80\n" +
                    "📐 Size XXL: 85-95kg, cao trên 1m80\n\n" +
                    "💡 Mỗi sản phẩm có bảng size chi tiết. Bạn có thể inbox với quản trị viên để được tư vấn size cụ thể hơn nhé!"
                ]
            },
            {
                id: 'payment',
                icon: '💳',
                text: 'Thanh toán',
                responses: [
                    "Các phương thức thanh toán:\n\n" +
                    "1️⃣ COD (Thanh toán khi nhận hàng)\n" +
                    "2️⃣ Chuyển khoản ngân hàng:\n" +
                    "   • Vietcombank\n" +
                    "   • Techcombank\n" +
                    "   • MBBank\n" +
                    "3️⃣ Ví điện tử: Momo, ZaloPay\n" +
                    "4️⃣ Quét mã QR\n\n" +
                    "✨ Đơn chuyển khoản được ưu tiên xử lý!"
                ]
            },
            {
                id: 'return',
                icon: '🔄',
                text: 'Đổi trả hàng',
                responses: [
                    "Chính sách đổi trả:\n\n" +
                    "✅ Đổi size MIỄN PHÍ trong 7 ngày\n" +
                    "✅ Trả hàng hoàn tiền nếu:\n" +
                    "   • Sản phẩm lỗi do nhà sản xuất\n" +
                    "   • Giao sai màu/size/sản phẩm\n" +
                    "   • Hàng không đúng mô tả\n\n" +
                    "⚠️ Điều kiện:\n" +
                    "   • Còn nguyên tem, mác\n" +
                    "   • Chưa qua sử dụng\n" +
                    "   • Không giặt, không hư hỏng\n\n" +
                    "📞 Liên hệ ngay để được hỗ trợ!"
                ]
            },
            {
                id: 'warranty',
                icon: '🛡️',
                text: 'Bảo hành',
                responses: [
                    "Chính sách bảo hành:\n\n" +
                    "🔰 Bảo hành 6 tháng cho:\n" +
                    "   • Suit cao cấp\n" +
                    "   • Áo khoác\n" +
                    "   • Giày dép\n\n" +
                    "🔰 Bảo hành 3 tháng cho:\n" +
                    "   • Áo sơ mi\n" +
                    "   • Quần tây\n" +
                    "   • Phụ kiện\n\n" +
                    "✨ Bảo hành bao gồm:\n" +
                    "   • Sửa chữa lỗi kỹ thuật\n" +
                    "   • Thay thế nếu lỗi nghiêm trọng\n" +
                    "   • Tư vấn bảo quản sản phẩm"
                ]
            },
            {
                id: 'discount',
                icon: '🎁',
                text: 'Khuyến mãi',
                responses: [
                    "Chương trình khuyến mãi HOT:\n\n" +
                    "🎉 GIẢM 20% toàn bộ áo thun\n" +
                    "🎉 GIẢM 15% combo từ 2 sản phẩm\n" +
                    "🎉 TẶNG voucher 100K cho đơn từ 1 triệu\n" +
                    "🎉 Freeship toàn quốc đơn từ 500K\n\n" +
                    "⏰ Áp dụng đến hết tháng này!\n" +
                    "💝 Tích điểm đổi quà cho khách hàng thân thiết\n\n" +
                    "Nhập mã: NEWYEAR2024 để nhận ưu đãi!"
                ]
            },
            {
                id: 'contact',
                icon: '📞',
                text: 'Liên hệ',
                responses: [
                    "Thông tin liên hệ:\n\n" +
                    "📍 Địa chỉ: 123 Đường ABC, Quận XYZ, TP.HCM\n" +
                    "☎️ Hotline: 1900 xxxx (8h-22h)\n" +
                    "📧 Email: support@cuahangquanao.vn\n" +
                    "💬 Facebook: fb.com/cuahangquanao\n" +
                    "🕒 Giờ làm việc:\n" +
                    "   • Thứ 2 - Thứ 7: 8h - 22h\n" +
                    "   • Chủ nhật: 9h - 21h\n\n" +
                    "Bạn cũng có thể chat trực tiếp với quản trị viên!"
                ]
            },
            {
                id: 'quality',
                icon: '⭐',
                text: 'Chất lượng',
                responses: [
                    "Cam kết chất lượng:\n\n" +
                    "✅ 100% hàng chính hãng\n" +
                    "✅ Nguồn gốc xuất xứ rõ ràng\n" +
                    "✅ Chất liệu cao cấp:\n" +
                    "   • Cotton 100% tự nhiên\n" +
                    "   • Vải thun co giãn 4 chiều\n" +
                    "   • Kaki, jean cao cấp\n" +
                    "✅ Kiểm tra kỹ trước khi giao\n" +
                    "✅ Đóng gói chuyên nghiệp\n\n" +
                    "🏆 Được hơn 10,000 khách hàng tin tưởng!"
                ]
            },
            {
                id: 'admin',
                icon: '👨‍💼',
                text: 'Chat admin',
                responses: [
                    "Bạn muốn chat trực tiếp với quản trị viên? Điều đó thật tuyệt vời! 😊\n\n" +
                    "Quản trị viên có thể hỗ trợ bạn:\n" +
                    "✅ Tư vấn chi tiết về sản phẩm\n" +
                    "✅ Giải đáp thắc mắc cụ thể\n" +
                    "✅ Hỗ trợ đặt hàng nhanh chóng\n" +
                    "✅ Xử lý khiếu nại, đổi trả\n\n" +
                    "Bạn có muốn tôi chuyển sang chat với quản trị viên không?"
                ]
            }
        ];
        
        // Render quick questions
        function renderQuickQuestions() {
            const grid = document.getElementById('quickQuestionsGrid');
            grid.innerHTML = '';
            
            quickQuestions.forEach(question => {
                const btn = document.createElement('button');
                btn.className = 'quick-question-btn';
                btn.innerHTML = `
                    <span class="quick-question-icon">${question.icon}</span>
                    <span>${question.text}</span>
                `;
                btn.onclick = () => handleQuickQuestion(question);
                grid.appendChild(btn);
            });
        }
        
        // Xử lý khi click vào quick question
        function handleQuickQuestion(question) {
            // Thêm hiệu ứng click
            event.target.closest('.quick-question-btn').classList.add('clicked');
            setTimeout(() => {
                event.target.closest('.quick-question-btn').classList.remove('clicked');
            }, 300);
            
            // Hiển thị câu hỏi của user
            addChatMessage(currentChatUser, question.text, getCurrentTime(), true, false);
            
            // Bot typing
            setTimeout(() => {
                showChatTyping("Bot");
            }, 500);
            
            // Hiển thị câu trả lời
            setTimeout(() => {
                hideChatTyping();
                const response = question.responses[Math.floor(Math.random() * question.responses.length)];
                
                // Nếu là câu hỏi về admin, tự động hỏi chuyển sang admin
                if (question.id === 'admin') {
                    addChatMessage("Bot", response, getCurrentTime(), false, false);
                } else {
                    addChatMessage("Bot", response, getCurrentTime(), false, false);
                    
                    // Sau khi trả lời, hỏi thêm
                    setTimeout(() => {
                        addChatMessage("Bot", "Bạn còn thắc mắc gì khác không? 😊", getCurrentTime(), false, false);
                    }, 1000);
                }
            }, 1500);
        }
        
        // Toggle chat window
        document.getElementById('chatWidgetButton').addEventListener('click', function() {
            const widget = document.getElementById('chatWidget');
            widget.classList.toggle('active');
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                unreadMessages = 0;
                updateBadge();
            }
        });

        document.getElementById('closeChat').addEventListener('click', function() {
            document.getElementById('chatWidget').classList.remove('active');
            isChatOpen = false;
        });

        function initChatConnection() {
            chatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .withAutomaticReconnect()
                .build();

            chatConnection.on("ReceiveAdminMessage", (adminName, message, time) => {
                addChatMessage(adminName, message, time, false, true);
                if (!isChatOpen) {
                    unreadMessages++;
                    updateBadge();
                }
            });

            chatConnection.on("MessageSent", (message, time) => {
                // Message already displayed
            });

            chatConnection.on("SupportRequested", () => {
                addSystemChatMessage("✅ Đã gửi yêu cầu hỗ trợ. Quản trị viên sẽ trả lời bạn sớm.", true);
            });

            chatConnection.on("UpdateOnlineUsers", (count) => {
                document.getElementById('onlineUsersCount').textContent = count;
            });

            chatConnection.start()
                .then(() => {
                    console.log("Chat connected");
                    chatConnection.invoke("JoinChat", currentChatUser, false);
                })
                .catch(err => console.error(err));
        }

        function startChat() {
            const username = document.getElementById('chatUsername').value.trim();
            if (username) {
                currentChatUser = username;
                document.getElementById('chatWelcome').style.display = 'none';
                document.getElementById('chatSupportOptions').style.display = 'block';
            }
        }

        function continueWithBot() {
            chatMode = "bot";
            document.getElementById('chatSupportOptions').style.display = 'none';
            document.getElementById('chatBody').style.display = 'block';
            document.getElementById('chatInput').style.display = 'flex';
            
            // HIỂN THỊ QUICK QUESTIONS
            document.getElementById('quickQuestionsContainer').style.display = 'block';
            renderQuickQuestions();
            
            const badge = document.getElementById('chatModeBadge');
            badge.textContent = "🤖 Bot AI";
            badge.style.display = 'inline-block';
            badge.classList.remove('admin-mode');
            
            addSystemChatMessage(`Chào ${currentChatUser}! Tôi là Bot hỗ trợ.`);
            setTimeout(() => {
                addChatMessage("Bot", "Bạn có thể chọn câu hỏi bên dưới hoặc nhập câu hỏi của riêng bạn! 😊", getCurrentTime(), false, false);
            }, 800);
        }

        function requestAdminSupport() {
            chatMode = "admin";
            document.getElementById('chatSupportOptions').style.display = 'none';
            document.getElementById('chatBody').style.display = 'block';
            document.getElementById('chatInput').style.display = 'flex';
            
            // ẨN QUICK QUESTIONS khi chat với admin
            document.getElementById('quickQuestionsContainer').style.display = 'none';
            
            const badge = document.getElementById('chatModeBadge');
            badge.textContent = "👨‍💼 Quản trị viên";
            badge.style.display = 'inline-block';
            badge.classList.add('admin-mode');
            
            initChatConnection();
            addSystemChatMessage(`Chào ${currentChatUser}! Đang kết nối với quản trị viên...`, true);
            
            setTimeout(() => {
                if (chatConnection && chatConnection.state === "Connected") {
                    chatConnection.invoke("RequestAdminSupport", currentChatUser);
                }
            }, 1000);
        }

        // Danh sách từ khóa đồng ý
        const agreeKeywords = [
            'có', 'được', 'ok', 'okay', 'đồng ý', 'yes', 'yeah', 'oke', 
            'uh', 'uhm', 'vâng', 'dạ', 'rồi', 'chắc chắn', 'tất nhiên',
            'muốn', 'cần', 'giúp', 'hỗ trợ'
        ];

        function isAgreementMessage(message) {
            const msg = message.toLowerCase().trim();
            return agreeKeywords.some(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b|^${keyword}$`, 'i');
                return regex.test(msg);
            });
        }

        function autoSwitchToAdmin() {
            chatMode = "admin";
            
            // ẨN QUICK QUESTIONS khi chuyển sang admin
            document.getElementById('quickQuestionsContainer').style.display = 'none';
            
            const badge = document.getElementById('chatModeBadge');
            badge.textContent = "👨‍💼 Quản trị viên";
            badge.classList.add('admin-mode');
            
            if (!chatConnection || chatConnection.state !== "Connected") {
                initChatConnection();
            }
            
            addSystemChatMessage("🔄 Đang chuyển bạn sang quản trị viên...", true);
            
            setTimeout(() => {
                if (chatConnection && chatConnection.state === "Connected") {
                    chatConnection.invoke("RequestAdminSupport", currentChatUser);
                    addSystemChatMessage("✅ Đã kết nối với quản trị viên. Vui lòng chờ phản hồi.", true);
                }
            }, 1500);
        }

        function getBotResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            // Tìm kiếm trong quick questions trước
            for (const question of quickQuestions) {
                if (msg.includes(question.text.toLowerCase()) || 
                    msg.includes(question.id)) {
                    return question.responses[Math.floor(Math.random() * question.responses.length)];
                }
            }
            
            // Phân tích từ khóa
            if (msg.includes("xin chào") || msg.includes("chào") || msg.includes("hello") || msg.includes("hi")) {
                return quickQuestions.find(q => q.id === 'greeting').responses[0];
            } 
            else if (msg.includes("giá") || msg.includes("bao nhiêu") || msg.includes("tiền")) {
                return quickQuestions.find(q => q.id === 'price').responses[0];
            } 
            else if (msg.includes("giao hàng") || msg.includes("ship") || msg.includes("vận chuyển")) {
                return quickQuestions.find(q => q.id === 'shipping').responses[0];
            } 
            else if (msg.includes("size") || msg.includes("kích thước") || msg.includes("cỡ")) {
                return quickQuestions.find(q => q.id === 'size').responses[0];
            } 
            else if (msg.includes("sản phẩm") || msg.includes("áo") || msg.includes("quần")) {
                return quickQuestions.find(q => q.id === 'products').responses[0];
            }
            else if (msg.includes("thanh toán") || msg.includes("payment") || msg.includes("trả tiền")) {
                return quickQuestions.find(q => q.id === 'payment').responses[0];
            }
            else if (msg.includes("đổi") || msg.includes("trả") || msg.includes("hoàn")) {
                return quickQuestions.find(q => q.id === 'return').responses[0];
            }
            else if (msg.includes("bảo hành") || msg.includes("warranty")) {
                return quickQuestions.find(q => q.id === 'warranty').responses[0];
            }
            else if (msg.includes("khuyến mãi") || msg.includes("giảm giá") || msg.includes("sale")) {
                return quickQuestions.find(q => q.id === 'discount').responses[0];
            }
            else if (msg.includes("liên hệ") || msg.includes("contact") || msg.includes("địa chỉ")) {
                return quickQuestions.find(q => q.id === 'contact').responses[0];
            }
            else if (msg.includes("admin") || msg.includes("quản trị") || msg.includes("nhân viên")) {
                return "Hmm, câu hỏi của bạn hơi khó đấy. Bạn có muốn chat với quản trị viên không?";
            } 
            else {
                return "Xin lỗi, tôi chưa hiểu rõ câu hỏi này. Bạn có thể chọn một trong các câu hỏi thường gặp bên dưới, hoặc chat với quản trị viên để được hỗ trợ tốt hơn nhé! 😊";
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message) {
                if (chatMode === "bot") {
                    addChatMessage(currentChatUser, message, getCurrentTime(), true, false);
                    input.value = "";
                    
                    // Kiểm tra câu trả lời đồng ý
                    if (isAgreementMessage(message)) {
                        const chatBody = document.getElementById('chatBody');
                        const lastMessages = chatBody.querySelectorAll('.chat-message-text');
                        const lastBotMessage = Array.from(lastMessages)
                            .slice(-2, -1)[0]?.textContent || '';
                        
                        if (lastBotMessage.includes('quản trị viên') || 
                            lastBotMessage.includes('admin') || 
                            lastBotMessage.includes('nhân viên')) {
                            
                            setTimeout(() => {
                                addChatMessage("Bot", "Được rồi! Tôi sẽ chuyển bạn sang quản trị viên ngay.", 
                                    getCurrentTime(), false, false);
                            }, 500);
                            
                            setTimeout(() => {
                                autoSwitchToAdmin();
                            }, 2000);
                            
                            return;
                        }
                    }
                    
                    // Bot typing
                    setTimeout(() => {
                        showChatTyping("Bot");
                    }, 500);
                    
                    setTimeout(() => {
                        hideChatTyping();
                        const botResponse = getBotResponse(message);
                        addChatMessage("Bot", botResponse, getCurrentTime(), false, false);
                    }, 1500);
                    
                } else if (chatMode === "admin" && chatConnection) {
                    chatConnection.invoke("SendMessageToAdmin", currentChatUser, message)
                        .catch(err => console.error(err));
                    addChatMessage(currentChatUser, message, getCurrentTime(), true, false);
                    input.value = "";
                }
            }
        }

        function addChatMessage(user, message, time, isOutgoing, isAdmin) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');

            if (isOutgoing) {
                messageDiv.className = 'chat-message chat-message-outgoing';
                messageDiv.innerHTML = `
                    <div class="chat-message-content">
                        <div class="chat-message-text">${escapeHtml(message)}</div>
                        <div class="chat-message-time">${time}</div>
                    </div>
                `;
            } else {
                messageDiv.className = 'chat-message chat-message-incoming';
                const initial = user.charAt(0).toUpperCase();
                const userLabel = isAdmin ? `${user} (QTV)` : user;
                messageDiv.innerHTML = `
                    <div class="chat-avatar">${initial}</div>
                    <div class="chat-message-content">
                        <div class="chat-message-user">${userLabel}</div>
                        <div class="chat-message-text">${escapeHtml(message).replace(/\n/g, '<br>')}</div>
                        <div class="chat-message-time">${time}</div>
                    </div>
                `;
            }

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addSystemChatMessage(message, isSpecial = false) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-system-message ${isSpecial ? 'switching' : ''}`;
            messageDiv.textContent = message;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function showChatTyping(username) {
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${username} đang gõ...`;
            indicator.style.display = 'block';
        }

        function hideChatTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function updateBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        document.getElementById('chatUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startChat();
            }
        });
    </script>
</body>
</html>
