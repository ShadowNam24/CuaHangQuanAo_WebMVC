<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - CuaHangQuanAo</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/CuaHangQuanAo.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    @RenderSection("Meta", required: false)

</head>
<body>
    <header>
        <!-- Modern navbar with better aesthetics -->
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background: linear-gradient(135deg, #0a2463 0%, #3e92cc 100%);">
            <div class="container">
                <!-- Enhanced Brand with animation -->
                <a class="navbar-brand d-flex align-items-center" asp-controller="Home" asp-action="Index">
                    <img class="logo me-2" src="~/Images/demo/logo.svg" onerror="this.style.display='none';" alt="logo"
                         style="width: 42px; height: auto; transition: all 0.3s ease-in-out;">
                    <span class="fw-bold fs-4" style="letter-spacing: 0.8px; background: linear-gradient(to right, #fff, #e6e6e6);
                       -webkit-background-clip: text; background-clip: text; color: transparent;">CuaHangQuanAo</span>
                </a>

                <button class="navbar-toggler border-0 shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Enhanced Search Box -->
                    <div class="mx-auto my-3 my-lg-0" style="max-width: 50%;">
                        <div class="position-relative">
                            <div class="input-group">
                                <input id="homeSearch" type="search" class="form-control form-control-lg border-0 shadow-none"
                                       placeholder="Tìm sản phẩm bạn muốn... (gõ để tìm nhanh)"
                                       style="border-radius: 25px 0 0 25px; background-color: rgba(255,255,255,0.15); color: #fff;">
                                <button class="btn btn-light px-3" type="button" style="border-radius: 0 25px 25px 0; background: rgba(255,255,255,0.25); border: none;">
                                    <i class="bi bi-search text-white"></i>
                                </button>
                            </div>
                            <!-- Dropdown suggestion box -->
                            <div id="suggestBox" class="list-group position-absolute w-100 shadow-sm rounded-3 mt-1"
                                 style="z-index:1000; display:none; max-height:360px; overflow:auto;"></div>
                        </div>
                        <div id="ajaxResults" class="mt-2"></div>
                    </div>

                    <!-- Enhanced Nav items with hover effects -->
                    <ul class="navbar-nav ms-auto align-items-lg-center">
                        <!-- Categories with subtle hover animations -->
                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="aoDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-tshirt me-1"></i> Áo
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2 animate__animated animate__fadeIn"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="aoDropdown">
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="7">Áo thun</a></li>
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="5">Áo sơ mi</a></li>
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="4">Áo polo</a></li>
                                <li><a class="dropdown-item py-2 hover-bg-light" asp-controller="Product" asp-action="QuanAo" asp-route-q="áo khoác">Áo khoác</a></li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="quanDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-handbag me-1"></i> Quần
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="quanDropdown">
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-q="jeans">Quần jeans</a></li>
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-q="short">Quần short</a></li>
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="3">Quần tây</a></li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="phuKienDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-gem me-1"></i> Phụ kiện
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="phuKienDropdown">
                                <li>
                                    <a class="dropdown-item py-2" asp-controller="Product" asp-action="PhuKien" asp-route-CategoryId="8">
                                        <i class="bi bi-shoe-1 me-2"></i> Giày
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item py-2" asp-controller="Product" asp-action="PhuKien" asp-route-CategoryId="9">
                                        <i class="bi bi-award me-2"></i> Thắt lưng
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider opacity-25" /></li>
                                <li>
                                    <a class="dropdown-item py-2" asp-controller="Product" asp-action="PhuKien">
                                        <i class="bi bi-grid me-2"></i> Tất cả phụ kiện
                                    </a>
                                </li>
                            </ul>
                        </li>

                        <li class="nav-item dropdown mx-1">
                            <a class="nav-link dropdown-toggle text-white fw-medium position-relative" href="#" id="suitDropdown"
                               role="button" data-bs-toggle="dropdown" aria-expanded="false"
                               style="transition: all 0.3s ease;">
                                <i class="bi bi-suit-heart me-1"></i> Suit
                                <span class="position-absolute" style="height: 2px; width: 0; background: #fff; bottom: 0; left: 50%;
                                   transform: translateX(-50%); transition: width 0.3s ease;"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 rounded-3 mt-2"
                                style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                aria-labelledby="suitDropdown">
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="2">Suit luxury</a></li>
                                <li><a class="dropdown-item py-2" asp-controller="Product" asp-action="QuanAo" asp-route-CategoryId="1">BST Vest</a></li>
                            </ul>
                        </li>

                        <!-- Enhanced Auth buttons -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            <li class="nav-item mx-1">
                                <a class="nav-link text-white position-relative" asp-controller="Cart" asp-action="Index">
                                    <i class="bi bi-cart-fill fs-5"></i>
                                    <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                                          style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000;">
                                        0
                                        <span class="visually-hidden">items in cart</span>
                                    </span>
                                </a>
                            </li>
                            <li class="nav-item dropdown mx-1">
                                <a class="nav-link dropdown-toggle text-white" href="#" id="userDropdown"
                                   role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="bi bi-person-circle fs-5 me-1"></i>
                                    <span class="d-none d-lg-inline" style="font-weight: 500;">@User.Identity.Name</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0 rounded-3 mt-2"
                                    style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);"
                                    aria-labelledby="userDropdown">
                                    <li>
                                        <a class="dropdown-item py-2" asp-controller="Profile" asp-action="Index">
                                            <i class="bi bi-person-badge me-2 text-primary"></i> Thông tin cá nhân
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item py-2" asp-controller="Profile" asp-action="Orders">
                                            <i class="bi bi-receipt me-2 text-success"></i> Đơn hàng của tôi
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider opacity-25" /></li>
                                    <li>
                                        <form asp-controller="Account" asp-action="Logout" method="post" class="d-inline">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="dropdown-item py-2 text-danger">
                                                <i class="bi bi-box-arrow-right me-2"></i> Đăng xuất
                                            </button>
                                        </form>
                                    </li>
                                </ul>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item ms-lg-2">
                                <a asp-controller="Account" asp-action="Register"
                                   class="btn btn-sm btn-outline-light rounded-pill px-3 me-2 fw-medium"
                                   style="border-width: 2px; transition: all 0.3s ease;">
                                    <i class="bi bi-person-plus-fill me-1"></i> Signup
                                </a>
                            </li>
                            <li class="nav-item">
                                <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path"
                                   class="btn btn-sm rounded-pill px-3 fw-medium"
                                   style="background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; box-shadow: 0 4px 10px rgba(255, 165, 0, 0.3); transition: all 0.3s ease;
                                   position: relative;">
                                    <i class="bi bi-box-arrow-in-right me-1"></i> Login
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill"
                                          style="background: radial-gradient(circle at top right, #FFD700, #FFA500); color: #000;
                                           transform: translate(50%, -50%); font-size: 80%; padding: 0.2em 0.5em;">NEW</span>
                                </a>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- Add this to the head section of the document -->
    <style>
        /* Hover effect for nav items */
        .navbar-nav .nav-link:hover .position-absolute {
            width: 80%;
        }

        /* Subtle hover animation for dropdown items */
        .dropdown-item {
            transition: all 0.2s ease;
            position: relative;
        }

            .dropdown-item:hover {
                background-color: rgba(0, 123, 255, 0.08);
                transform: translateX(5px);
            }

        /* Enhanced search input placeholder */
        #homeSearch::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Smooth transition for buttons */
        .btn {
            transition: all 0.3s ease;
        }

        .btn-outline-light:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        /* Logo hover animation */
        .navbar-brand:hover img {
            transform: scale(1.1) rotate(5deg);
        }

        /* Enhanced navbar shadow */
        .navbar {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* Chat widget styles */
        .chat-widget-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 9998;
            transition: all 0.3s ease;
            border: none;
        }

            .chat-widget-button:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
            }

            .chat-widget-button svg {
                width: 28px;
                height: 28px;
                fill: white;
            }

        .chat-widget-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        /* Cửa sổ chat */
        .chat-widget-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @@keyframes slideUp {
            from

        {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-widget-window.active {
            display: flex;
        }

        /* Header chat */
        .chat-widget-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-widget-header-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-widget-header-info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

            .chat-widget-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

        /* Body chat */
        .chat-widget-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-message-incoming {
            display: flex;
            gap: 10px;
        }

        .chat-message-outgoing {
            display: flex;
            justify-content: flex-end;
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message-content {
            max-width: 70%;
        }

        .chat-message-user {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .chat-message-text {
            background: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }

        .chat-message-outgoing .chat-message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .chat-system-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 10px 0;
            font-style: italic;
        }

        .chat-typing-indicator {
            display: none;
            padding: 10px 0;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        /* Input area */
        .chat-widget-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

            .chat-widget-input input {
                flex: 1;
                padding: 12px 15px;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.3s;
            }

                .chat-widget-input input:focus {
                    border-color: #667eea;
                }

        .chat-widget-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

            .chat-widget-send:hover {
                transform: scale(1.1);
            }

            .chat-widget-send svg {
                width: 20px;
                height: 20px;
                fill: white;
            }

        /* Welcome screen */
        .chat-welcome {
            text-align: center;
            padding: 40px 20px;
        }

        .chat-welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .chat-welcome-icon svg {
                width: 40px;
                height: 40px;
                fill: white;
            }

        .chat-welcome h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        .chat-welcome p {
            color: #666;
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        .chat-welcome input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
            outline: none;
        }

            .chat-welcome input:focus {
                border-color: #667eea;
            }

        .chat-welcome button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

            .chat-welcome button:hover {
                transform: translateY(-2px);
            }

        /* Online users count */
        .chat-online-users {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-online-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100%

        {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        }

        /* Responsive */
        @@media (max-width: 480px) {
            .chat-widget-window

        {
            width: calc(100% - 40px);
            height: calc(100vh - 110px);
            bottom: 90px;
            right: 20px;
            left: 20px;
        }

        }

        /* Thêm vào phần styles hiện có */
    
    .chat-mode-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #4ade80;
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
        transition: all 0.3s ease;
    }
    
    .chat-mode-badge.admin-mode {
        background: #f59e0b;
        animation: modeSwitch 0.5s ease;
    }
    
    @@keyframes modeSwitch {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Hiệu ứng cho tin nhắn system đặc biệt */
    .chat-system-message.switching {
        background: linear-gradient(90deg, #667eea, #764ba2);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 500;
    }
    </style>



    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="site-footer">
        <div class="footer-main">
            <div class="footer-columns">
                <div class="footer-col">
                    <h4>CuaHangQuanAo</h4>
                    <ul>
                        <li><a href="#">Giới thiệu</a></li>
                        <li><a href="#">Tuyển dụng</a></li>
                        <li><a href="#">Liên hệ</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>CHÍNH SÁCH</h4>
                    <ul>
                        <li><a href="#">Chính sách bảo hành</a></li>
                        <li><a href="#">Chính sách giao hàng</a></li>
                        <li><a href="#">Chính sách bảo mật</a></li>
                    </ul>
                </div>
                <div class="footer-col">
                    <h4>THÔNG TIN</h4>
                    <ul>
                        <li><a href="#">Hướng dẫn mua hàng</a></li>
                        <li><a href="#">Hướng dẫn thanh toán</a></li>
                        <li><a href="#">Hướng dẫn trả góp</a></li>
                        <li><a href="#">Tra cứu địa chỉ bảo hành</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    
    <script>
        // Load cart count on page load
        $(document).ready(function() {
            loadCartCount();
        });
        
        function loadCartCount() {
            $.get('/Cart/GetCartCount')
                .done(function(data) {
                    if (data && data.count !== undefined) {
                        $('#cartCount').text(data.count);
                    }
                })
                .fail(function() {
                    console.log('Failed to load cart count');
                });
        }
        
        // Function to update cart count (can be called from other pages)
        function updateCartCount(newCount) {
            $('#cartCount').text(newCount);
        }
    </script>
    
    @await RenderSectionAsync("Scripts", required: false)


    <!-- Thêm vào _Layout.cshtml hoặc Index.cshtml trước thẻ đóng </body> -->

    <style>
        /* Nút mở chat */
        .chat-widget-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 9998;
            transition: all 0.3s ease;
            border: none;
        }

            .chat-widget-button:hover {
                transform: scale(1.1);
                box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
            }

            .chat-widget-button svg {
                width: 28px;
                height: 28px;
                fill: white;
            }

        .chat-widget-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            display: none;
        }

        /* Cửa sổ chat */
        .chat-widget-window {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        @@keyframes slideUp {
            from

        {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-widget-window.active {
            display: flex;
        }

        /* Header chat */
        .chat-widget-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-widget-header-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-widget-header-info p {
            margin: 5px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .chat-widget-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

            .chat-widget-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

        /* Body chat */
        .chat-widget-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .chat-message {
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @@keyframes fadeIn {
            from

        {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .chat-message-incoming {
            display: flex;
            gap: 10px;
        }

        .chat-message-outgoing {
            display: flex;
            justify-content: flex-end;
        }

        .chat-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .chat-message-content {
            max-width: 70%;
        }

        .chat-message-user {
            font-size: 12px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .chat-message-text {
            background: white;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            word-wrap: break-word;
        }

        .chat-message-outgoing .chat-message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .chat-system-message {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin: 10px 0;
            font-style: italic;
        }

        .chat-typing-indicator {
            display: none;
            padding: 10px 0;
            color: #999;
            font-size: 13px;
            font-style: italic;
        }

        /* Input area */
        .chat-widget-input {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

            .chat-widget-input input {
                flex: 1;
                padding: 12px 15px;
                border: 1px solid #e0e0e0;
                border-radius: 20px;
                font-size: 14px;
                outline: none;
                transition: border-color 0.3s;
            }

                .chat-widget-input input:focus {
                    border-color: #667eea;
                }

        .chat-widget-send {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

            .chat-widget-send:hover {
                transform: scale(1.1);
            }

            .chat-widget-send svg {
                width: 20px;
                height: 20px;
                fill: white;
            }

        /* Welcome screen */
        .chat-welcome {
            text-align: center;
            padding: 40px 20px;
        }

        .chat-welcome-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .chat-welcome-icon svg {
                width: 40px;
                height: 40px;
                fill: white;
            }

        .chat-welcome h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 18px;
        }

        .chat-welcome p {
            color: #666;
            font-size: 14px;
            margin: 0 0 20px 0;
        }

        .chat-welcome input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            margin-bottom: 15px;
            outline: none;
        }

            .chat-welcome input:focus {
                border-color: #667eea;
            }

        .chat-welcome button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

            .chat-welcome button:hover {
                transform: translateY(-2px);
            }

        /* Online users count */
        .chat-online-users {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .chat-online-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100%

        {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        }

        /* Responsive */
        @@media (max-width: 480px) {
            .chat-widget-window

        {
            width: calc(100% - 40px);
            height: calc(100vh - 110px);
            bottom: 90px;
            right: 20px;
            left: 20px;
        }

        }

        /* Thêm vào phần styles hiện có */
    
    .chat-mode-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #4ade80;
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        margin-left: 10px;
        transition: all 0.3s ease;
    }
    
    .chat-mode-badge.admin-mode {
        background: #f59e0b;
        animation: modeSwitch 0.5s ease;
    }
    
    @@keyframes modeSwitch {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    /* Hiệu ứng cho tin nhắn system đặc biệt */
    .chat-system-message.switching {
        background: linear-gradient(90deg, #667eea, #764ba2);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        font-weight: 500;
    }
    </style>

    <!-- Nút mở chat -->
    <button class="chat-widget-button" id="chatWidgetButton">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
        </svg>
        <span class="chat-widget-badge" id="chatBadge">0</span>
    </button>

    <!-- Cửa sổ chat -->
    <div class="chat-widget-window" id="chatWidget">
        <div class="chat-widget-header">
            <div class="chat-widget-header-info">
                <h3>
                    💬 Live Chat
                    <span id="chatModeBadge" class="chat-mode-badge" style="display:none;">Bot</span>
                </h3>
                <div class="chat-online-users">
                    <span class="chat-online-dot"></span>
                    <p><span id="onlineUsersCount">0</span> người online</p>
                </div>
            </div>
            <button class="chat-widget-close" id="closeChat">✕</button>
        </div>

        <!-- Welcome screen -->
        <div class="chat-welcome" id="chatWelcome">
            <div class="chat-welcome-icon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                </svg>
            </div>
            <h4>Chào mừng bạn!</h4>
            <p>Nhập tên của bạn để bắt đầu trò chuyện</p>
            <input type="text" id="chatUsername" placeholder="Tên của bạn..." maxlength="20">
            <button onclick="startChat()">Bắt đầu chat</button>
        </div>

        <!-- Support options - Chọn bot hoặc admin -->
        <div class="chat-support-options" id="chatSupportOptions">
            <p style="margin:0 0 15px 0; font-weight:600; color:#333; text-align:center;">
                Bạn muốn chat với:
            </p>
            <button class="support-btn bot-btn" onclick="continueWithBot()">
                <span>🤖</span> <span>Chat với Bot AI</span>
            </button>
            <button class="support-btn admin-btn" onclick="requestAdminSupport()">
                <span>👨‍💼</span> <span>Nhắn với Quản trị viên</span>
            </button>
        </div>

        <!-- Chat body -->
        <div class="chat-widget-body" id="chatBody" style="display: none;"></div>

        <div class="chat-typing-indicator" id="typingIndicator">Ai đó đang gõ...</div>

        <!-- Input area -->
        <div class="chat-widget-input" id="chatInput" style="display: none;">
            <input type="text" id="messageInput" placeholder="Nhập tin nhắn...">
            <button class="chat-widget-send" onclick="sendChatMessage()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                </svg>
            </button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        let chatConnection = null;
        let currentChatUser = "";
        let chatTypingTimer;
        let unreadMessages = 0;
        let isChatOpen = false;
        let chatMode = "none"; // "bot", "admin", or "none"
        
        // Cập nhật lại botResponses
        const botResponses = {
            greeting: [
                "Xin chào! Tôi là trợ lý ảo của CuaHangQuanAo. Tôi có thể giúp gì cho bạn?",
                "Chào bạn! Rất vui được hỗ trợ bạn hôm nay. Bạn cần tư vấn gì không?"
            ],
            price: [
                "Giá sản phẩm của chúng tôi rất cạnh tranh, từ 200.000đ - 5.000.000đ tùy loại. Bạn quan tâm loại sản phẩm nào?",
                "Chúng tôi có nhiều mức giá phù hợp với mọi túi tiền. Bạn muốn xem sản phẩm trong tầm giá nào?"
            ],
            shipping: [
                "Chúng tôi có dịch vụ giao hàng toàn quốc. Miễn phí ship cho đơn từ 500.000đ trong nội thành.",
                "Phí ship chỉ 30.000đ cho đơn dưới 500.000đ. Giao hàng từ 2-5 ngày tùy khu vực."
            ],
            size: [
                "Chúng tôi có đầy đủ size từ S đến XXL. Bạn có thể tham khảo bảng size trên trang sản phẩm.",
                "Để chọn size phù hợp, bạn có thể xem hướng dẫn chọn size hoặc liên hệ admin để được tư vấn cụ thể hơn."
            ],
            product: [
                "Chúng tôi có nhiều sản phẩm: áo thun, áo sơ mi, quần jeans, suit... Bạn quan tâm loại nào?",
                "Sản phẩm của shop rất đa dạng và chất lượng cao. Bạn có thể xem catalog trên trang chủ."
            ],
            admin: [
                "Bạn muốn chat với quản trị viên? Tôi có thể chuyển bạn sang ngay!",
                "Để được tư vấn chi tiết hơn, tôi sẽ kết nối bạn với quản trị viên."
            ],
            default: [
                "Hmm, câu hỏi của bạn hơi khó đấy. Bạn có muốn chat với quản trị viên không?",
                "Tôi chưa hiểu rõ câu hỏi này. Bạn muốn tôi kết nối với quản trị viên để được hỗ trợ tốt hơn không?",
                "Xin lỗi, tôi chưa có thông tin về vấn đề này. Bạn có cần nói chuyện với quản trị viên không?"
            ]
        };

        // Toggle chat window
        document.getElementById('chatWidgetButton').addEventListener('click', function() {
            const widget = document.getElementById('chatWidget');
            widget.classList.toggle('active');
            isChatOpen = !isChatOpen;
            if (isChatOpen) {
                unreadMessages = 0;
                updateBadge();
            }
        });

        document.getElementById('closeChat').addEventListener('click', function() {
            document.getElementById('chatWidget').classList.remove('active');
            isChatOpen = false;
        });

        function initChatConnection() {
            chatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub")
                .withAutomaticReconnect()
                .build();

            // Nhận tin nhắn từ admin
            chatConnection.on("ReceiveAdminMessage", (adminName, message, time) => {
                addChatMessage(adminName, message, time, false, true);
                if (!isChatOpen) {
                    unreadMessages++;
                    updateBadge();
                }
            });

            chatConnection.on("MessageSent", (message, time) => {
                // Message already displayed
            });

            chatConnection.on("SupportRequested", () => {
                addSystemChatMessage("✅ Đã gửi yêu cầu hỗ trợ. Quản trị viên sẽ trả lời bạn sớm.");
            });

            chatConnection.on("UpdateOnlineUsers", (count) => {
                document.getElementById('onlineUsersCount').textContent = count;
            });

            chatConnection.start()
                .then(() => {
                    console.log("Chat connected");
                    chatConnection.invoke("JoinChat", currentChatUser, false);
                })
                .catch(err => console.error(err));
        }

        function startChat() {
            const username = document.getElementById('chatUsername').value.trim();
            if (username) {
                currentChatUser = username;
                document.getElementById('chatWelcome').style.display = 'none';
                document.getElementById('chatSupportOptions').style.display = 'block';
            }
        }

        function continueWithBot() {
            chatMode = "bot";
            document.getElementById('chatSupportOptions').style.display = 'none';
            document.getElementById('chatBody').style.display = 'block';
            document.getElementById('chatInput').style.display = 'flex';
            
            const badge = document.getElementById('chatModeBadge');
            badge.textContent = "🤖 Bot AI";
            badge.style.display = 'inline-block';
            badge.classList.remove('admin-mode');
            
            addSystemChatMessage(`Chào ${currentChatUser}! Tôi là Bot hỗ trợ.`);
            setTimeout(() => {
                const greeting = botResponses.greeting[Math.floor(Math.random() * botResponses.greeting.length)];
                addChatMessage("Bot", greeting, getCurrentTime(), false, false);
            }, 800);
        }

        function requestAdminSupport() {
            chatMode = "admin";
            document.getElementById('chatSupportOptions').style.display = 'none';
            document.getElementById('chatBody').style.display = 'block';
            document.getElementById('chatInput').style.display = 'flex';
            
            const badge = document.getElementById('chatModeBadge');
            badge.textContent = "👨‍💼 Quản trị viên";
            badge.style.display = 'inline-block';
            badge.classList.add('admin-mode');
            
            initChatConnection();
            addSystemChatMessage(`Chào ${currentChatUser}! Đang kết nối với quản trị viên...`);
            
            setTimeout(() => {
                if (chatConnection && chatConnection.state === "Connected") {
                    chatConnection.invoke("RequestAdminSupport", currentChatUser);
                }
            }, 1000);
        }

        // Danh sách từ khóa đồng ý
        const agreeKeywords = [
            'có', 'được', 'ok', 'okay', 'đồng ý', 'yes', 'yeah', 'oke', 
            'uh', 'uhm', 'vâng', 'dạ', 'rồi', 'chắc chắn', 'tất nhiên',
            'muốn', 'cần', 'giúp', 'hỗ trợ'
        ];

        // Hàm kiểm tra xem tin nhắn có phải là đồng ý không
        function isAgreementMessage(message) {
            const msg = message.toLowerCase().trim();
            
            // Kiểm tra từ đơn lẻ hoặc trong câu
            return agreeKeywords.some(keyword => {
                const regex = new RegExp(`\\b${keyword}\\b|^${keyword}$`, 'i');
                return regex.test(msg);
            });
        }

        // Hàm tự động chuyển sang admin support
        function autoSwitchToAdmin() {
            chatMode = "admin";
            
            const badge = document.getElementById('chatModeBadge');
            badge.textContent = "👨‍💼 Quản trị viên";
            badge.classList.add('admin-mode');
            
            if (!chatConnection || chatConnection.state !== "Connected") {
                initChatConnection();
            }
            
            addSystemChatMessage("🔄 Đang chuyển bạn sang quản trị viên...", true);
            
            setTimeout(() => {
                if (chatConnection && chatConnection.state === "Connected") {
                    chatConnection.invoke("RequestAdminSupport", currentChatUser);
                    addSystemChatMessage("✅ Đã kết nối với quản trị viên. Vui lòng chờ phản hồi.", true);
                }
            }, 1500);
        }

        // CẬP NHẬT hàm getBotResponse để phát hiện câu hỏi về admin
        function getBotResponse(userMessage) {
            const msg = userMessage.toLowerCase();
            
            if (msg.includes("xin chào") || msg.includes("chào") || msg.includes("hello") || msg.includes("hi")) {
                return botResponses.greeting[Math.floor(Math.random() * botResponses.greeting.length)];
            } 
            else if (msg.includes("giá") || msg.includes("bao nhiêu") || msg.includes("tiền")) {
                return botResponses.price[Math.floor(Math.random() * botResponses.price.length)];
            } 
            else if (msg.includes("giao hàng") || msg.includes("ship") || msg.includes("vận chuyển")) {
                return botResponses.shipping[Math.floor(Math.random() * botResponses.shipping.length)];
            } 
            else if (msg.includes("size") || msg.includes("kích thước") || msg.includes("cỡ")) {
                return botResponses.size[Math.floor(Math.random() * botResponses.size.length)];
            } 
            else if (msg.includes("sản phẩm") || msg.includes("áo") || msg.includes("quần")) {
                return botResponses.product[Math.floor(Math.random() * botResponses.product.length)];
            } 
            else if (msg.includes("admin") || msg.includes("quản trị") || msg.includes("nhân viên")) {
                // Bot hỏi có muốn chuyển sang admin không
                return "Hmm, câu hỏi của bạn hơi khó đấy. Bạn có muốn chat với quản trị viên không?";
            } 
            else {
                // Trả lời mặc định và gợi ý chuyển sang admin
                return botResponses.default[Math.floor(Math.random() * botResponses.default.length)];
            }
        }

        function sendChatMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (message) {
                if (chatMode === "bot") {
                    // Thêm tin nhắn của user
                    addChatMessage(currentChatUser, message, getCurrentTime(), true, false);
                    input.value = "";
                    
                    // KIỂM TRA CÂU TRẢ LỜI ĐỒNG Ý
                    if (isAgreementMessage(message)) {
                        // Nếu tin nhắn cuối của bot có chứa câu hỏi về admin
                        const chatBody = document.getElementById('chatBody');
                        const lastMessages = chatBody.querySelectorAll('.chat-message-text');
                        const lastBotMessage = Array.from(lastMessages)
                            .slice(-2, -1)[0]?.textContent || '';
                        
                        if (lastBotMessage.includes('quản trị viên') || 
                            lastBotMessage.includes('admin') || 
                            lastBotMessage.includes('nhân viên')) {
                            
                            // Tự động chuyển sang admin
                            setTimeout(() => {
                                addChatMessage("Bot", "Được rồi! Tôi sẽ chuyển bạn sang quản trị viên ngay.", 
                                    getCurrentTime(), false, false);
                            }, 500);
                            
                            setTimeout(() => {
                                autoSwitchToAdmin();
                            }, 2000);
                            
                            return; // Dừng xử lý bot
                        }
                    }
                    
                    // Giả lập bot đang gõ
                    setTimeout(() => {
                        showChatTyping("Bot");
                    }, 500);
                    
                    // Hiển thị câu trả lời sau 1.5s
                    setTimeout(() => {
                        hideChatTyping();
                        const botResponse = getBotResponse(message);
                        addChatMessage("Bot", botResponse, getCurrentTime(), false, false);
                    }, 1500);
                    
                } else if (chatMode === "admin" && chatConnection) {
                    // Chế độ admin - gửi qua SignalR
                    chatConnection.invoke("SendMessageToAdmin", currentChatUser, message)
                        .catch(err => console.error(err));
                    addChatMessage(currentChatUser, message, getCurrentTime(), true, false);
                    input.value = "";
                }
            }
        }

        function addChatMessage(user, message, time, isOutgoing, isAdmin) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');

            if (isOutgoing) {
                messageDiv.className = 'chat-message chat-message-outgoing';
                messageDiv.innerHTML = `
                    <div class="chat-message-content">
                        <div class="chat-message-text">${escapeHtml(message)}</div>
                        <div class="chat-message-time">${time}</div>
                    </div>
                `;
            } else {
                messageDiv.className = 'chat-message chat-message-incoming';
                const initial = user.charAt(0).toUpperCase();
                const userLabel = isAdmin ? `${user} (QTV)` : user;
                messageDiv.innerHTML = `
                    <div class="chat-avatar">${initial}</div>
                    <div class="chat-message-content">
                        <div class="chat-message-user">${userLabel}</div>
                        <div class="chat-message-text">${escapeHtml(message)}</div>
                        <div class="chat-message-time">${time}</div>
                    </div>
                `;
            }

            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addSystemChatMessage(message, isSpecial = false) {
            const chatBody = document.getElementById('chatBody');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-system-message ${isSpecial ? 'switching' : ''}`;
            messageDiv.textContent = message;
            chatBody.appendChild(messageDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function showChatTyping(username) {
            const indicator = document.getElementById('typingIndicator');
            indicator.textContent = `${username} đang gõ...`;
            indicator.style.display = 'block';
        }

        function hideChatTyping() {
            document.getElementById('typingIndicator').style.display = 'none';
        }

        function updateBadge() {
            const badge = document.getElementById('chatBadge');
            if (unreadMessages > 0) {
                badge.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function getCurrentTime() {
            const now = new Date();
            return `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        document.getElementById('chatUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startChat();
            }
        });
    </script>
</body>
</html>
