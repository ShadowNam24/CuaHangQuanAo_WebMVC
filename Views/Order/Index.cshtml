@model IEnumerable<CuaHangQuanAo.Entities.Order>

@{
    ViewData["Title"] = "Quản lý đơn hàng";
    Layout = "_AdminLayout";

    Func<string, string> statusClass = s => s switch
    {
        "pending" => "status-pending",
        "processing" => "status-processing",
        "fulfilled" => "status-fulfilled",
        "cancelled" => "status-cancelled",
        _ => "status-pending"
    };

    var totalOrders = Model.Count();
    var totalRevenue = Model.Sum(o => o.Total ?? 0);
    var avgRevenue = totalOrders > 0 ? totalRevenue / totalOrders : 0;
}

<style>
    :root {
        --brand-primary: #1E3A8A;
        --brand-secondary: #3B82F6;
        --brand-accent: #22C55E;
        --brand-warning: #F59E0B;
        --brand-danger: #EF4444;
        --brand-muted: #F3F4F6;
        --text-muted: #6B7280;
    }

    .page-hero {
        background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
        color: #fff;
        border-radius: 1rem;
        padding: 1.25rem 1.5rem;
        box-shadow: 0 12px 28px rgba(30,58,138,.18);
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .hero-title { font-size: 1.35rem; font-weight: 800; }
    .hero-sub { opacity:.85; font-size:.9rem; }
    .hero-btn { border-radius:999px; padding:.5rem 1rem; font-weight:700; }

    .metrics {
        display:grid;
        grid-template-columns: repeat(3,1fr);
        gap: 1rem;
        margin: 1rem 0 1.25rem;
    }
    .metric-card {
        background:#fff;
        border:1px solid #e5e7eb;
        border-radius: .85rem;
        padding: .9rem 1rem;
        box-shadow:0 10px 24px rgba(30,58,138,.08);
    }
    .metric-label { color:var(--text-muted); font-weight:600; }
    .metric-value { font-size:1.25rem; font-weight:800; color:#111827; }

    .orders-card {
        border-radius: 1rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 24px rgba(30,58,138,.08);
        overflow: hidden;
        background: #fff;
    }
    .toolbar {
        display:flex; gap:.75rem; align-items:center; justify-content:space-between; padding: .75rem 1rem;
    }
    .search-input { max-width: 360px; }
    .table-orders thead th {
        background: var(--brand-muted);
        color: #111827;
        font-weight: 700;
        border-bottom: 1px solid #e5e7eb;
    }
    .table-orders tbody tr:hover { background:#f9fafb; }
    .status-badge {
        text-transform: uppercase;
        border-radius: 999px;
        font-weight: 700;
        padding: 0.25rem 0.6rem;
        font-size: .75rem;
    }
    .status-pending { background-color: #FDE68A; color: #92400E; }
    .status-processing { background-color: #BFDBFE; color: #1E3A8A; }
    .status-fulfilled { background-color: #A7F3D0; color: #065F46; }
    .status-cancelled { background-color: #FECACA; color: #7F1D1D; }
    .pill {
        border-radius: 999px; padding:.25rem .6rem; font-weight:700; font-size:.8rem; display:inline-flex; align-items:center; gap:.35rem;
        border:1px solid transparent;
    }
    .pill-blue { color:#1E3A8A; border-color:#93C5FD; background:#EFF6FF; }
    .pill-yellow { color:#92400E; border-color:#FCD34D; background:#FFFBEB; }
    .pill-red { color:#7F1D1D; border-color:#FCA5A5; background:#FEF2F2; }
    .btn-action { border-radius:999px; padding:.35rem .8rem; font-weight:600; }
    .btn-primary.btn-action { background-color: var(--brand-secondary); border-color: var(--brand-secondary); }
</style>

<div class="page-hero mb-3">
    <div>
        <div class="hero-title"><i class="bi bi-bag-check me-2"></i>Danh sách đơn hàng</div>
        <div class="hero-sub">Quản lý đơn hàng trong cửa hàng</div>
    </div>
    <a href="@Url.Action("Index","Order")" class="btn btn-light hero-btn"><i class="bi bi-arrow-repeat me-1"></i>Tải lại</a>
</div>

<div class="metrics">
    <div class="metric-card">
        <div class="metric-label"><i class="bi bi-basket3 me-1 text-primary"></i>Tổng đơn hàng</div>
        <div class="metric-value">@totalOrders</div>
    </div>
    <div class="metric-card">
        <div class="metric-label"><i class="bi bi-graph-up-arrow me-1 text-success"></i>Doanh thu</div>
        <div class="metric-value">@string.Format("{0:N0} đ", totalRevenue)</div>
    </div>
    <div class="metric-card">
        <div class="metric-label"><i class="bi bi-tag me-1 text-warning"></i>Giá trung bình</div>
        <div class="metric-value">@string.Format("{0:N0} đ", avgRevenue)</div>
    </div>
</div>

<div class="orders-card">
    <div class="toolbar">
        <div class="input-group search-input">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input id="orderSearch" class="form-control form-control-sm" placeholder="Tìm kiếm theo khách hàng, mã đơn, trạng thái..." />
        </div>
        <div class="d-flex gap-2">
            <span class="pill pill-blue"><i class="bi bi-info-circle"></i> pending</span>
            <span class="pill pill-yellow"><i class="bi bi-gear"></i> processing</span>
            <span class="pill pill-blue"><i class="bi bi-check2-circle"></i> fulfilled</span>
            <span class="pill pill-red"><i class="bi bi-x-circle"></i> cancelled</span>
        </div>
    </div>

    <div class="table-responsive">
        <table id="ordersTable" class="table table-hover table-orders mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Mã đơn</th>
                    <th>Khách hàng</th>
                    <th>Ngày đặt</th>
                    <th>Tổng</th>
                    <th>Trạng thái</th>
                    <th>Hành động</th>
                    <th>Đổi trạng thái</th>
                </tr>
            </thead>
            <tbody>
            @{
                var stt = 1;
            }
            @foreach (var o in Model)
            {
                var s = o.Status ?? "pending";
                <tr>
                    <td>@stt</td>
                    <td>#@o.OrdersId</td>
                    <td>@(string.IsNullOrWhiteSpace(o.CustomerName)
                            ? (o.Customer != null ? (o.Customer.LastName + " " + o.Customer.FirstName).Trim() : "Không rõ")
                            : o.CustomerName)</td>
                    <td>@o.OrderDate?.ToString("dd/MM/yyyy")</td>
                    <td>@string.Format("{0:N0} đ", o.Total)</td>
                    <td><span class="status-badge @statusClass(s)">@s</span></td>
                    <td class="d-flex gap-2">
                        <a class="pill pill-blue text-decoration-none" href="@Url.Action("Functions_Details","Order", new { id = o.OrdersId })"><i class="bi bi-eye"></i> Chi tiết</a>
                        <a class="pill pill-yellow text-decoration-none" href="@Url.Action("Functions_Edit","Order", new { id = o.OrdersId })"><i class="bi bi-pencil-square"></i> Sửa</a>
                        <a class="pill pill-red text-decoration-none" href="@Url.Action("Functions_Delete","Order", new { id = o.OrdersId })"><i class="bi bi-trash"></i> Xóa</a>
                    </td>
                    <td>
                        <form asp-action="ChangeStatus" asp-controller="Order" method="post" class="d-flex gap-2">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@o.OrdersId" />
                            <select name="status" class="form-select form-select-sm w-auto">
                                <option value="pending" selected="@(o.Status=="pending")">pending</option>
                                <option value="processing" selected="@(o.Status=="processing")">processing</option>
                                <option value="fulfilled" selected="@(o.Status=="fulfilled")">fulfilled</option>
                                <option value="cancelled" selected="@(o.Status=="cancelled")">cancelled</option>
                            </select>
                            <button type="submit" class="btn btn-primary btn-sm btn-action">Cập nhật</button>
                        </form>
                    </td>
                </tr>
                stt++;
            }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        // Client-side search on table
        const input = document.getElementById('orderSearch');
        const table = document.getElementById('ordersTable');
        input?.addEventListener('input', () => {
            const q = input.value.toLowerCase();
            for (const row of table.tBodies[0].rows) {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(q) ? '' : 'none';
            }
        });
    </script>
    <script>
        // Redirect Admin back navigation to Admin home
        if (window.performance && performance.getEntriesByType) {
            const nav = performance.getEntriesByType('navigation')[0];
            if (nav && (nav.type === 'back_forward' || nav.type === 'reload')) {
                window.history.replaceState(null, '', '/Admin'); // change if your admin home differs
            }
        }
        // Optional: pressing browser back while on Order list goes to Admin home
        window.addEventListener('popstate', () => {
            location.replace('/Admin'); // change to your Admin home route
        });
    </script>
}

